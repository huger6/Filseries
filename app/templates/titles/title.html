{% extends "base.html" %}
<!-- Title -->
{% block title %}
- {{ primaryTitle }}
{% endblock %}

<!-- CSS -->
{% block css %}
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/title.css')}}">
{% endblock %}

<!-- Scripts -->
{% block head_scripts %}
    <script>
        const defaultPoster = "{{url_for('static', filename='img/defaultPoster.svg')}}";
        const defaultBackground = "{{url_for('static', filename='img/background.jpeg')}}";
        const isAuthenticated = "{{ 'true' if current_user.is_authenticated else 'false' }}"; // "true" (string!)
        const loginUrl = "{{url_for('auth.login')}}";
    </script>
{% endblock %}

{% block main %}
    <div id="title-page" data-results='{{ (results | tojson | safe) if results else "{}" }}'>
        {% if results %}
            <!-- Backdrop -->
            <div class="title-backdrop" id="title-backdrop"></div>
            
            <div class="title-content">
                <div class="title-main">
                    <!-- Poster -->
                    <div class="poster-section">
                        <div class="poster-wrapper">
                            <div id="title-poster"></div>
                            {% if results.vote_average %}
                                <div class="poster-rating">
                                    <i class="bi bi-star-fill"></i>
                                    <span>{{ "%.1f"|format(results.vote_average) }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Info -->
                    <div class="info-section">
                        <div class="title-header">
                            <h1 class="title-name">{{ results.title if results.title else "Unknown Title" }}</h1>
                            {% if results.tagline %}
                            <p class="title-tagline">"{{ results.tagline }}"</p>
                            {% endif %}
                        </div>
                        
                        <div class="title-meta">
                            {% if results.release_date %}
                                <span class="meta-item">
                                    <i class="bi bi-calendar3"></i>
                                    {{ results.release_date }}
                                </span>
                            {% endif %}
                            {% if results.runtime %}
                                <span class="meta-item">
                                    <i class="bi bi-clock"></i>
                                    {{ results.runtime }} min
                                </span>
                            {% endif %}
                            {% if results.vote_average %}
                                <span class="meta-item rating">
                                    <i class="bi bi-star-fill"></i>
                                    {{ "%.1f"|format(results.vote_average) }}/10
                                </span>
                            {% endif %}
                            {% if results.media_type == "tv" and results.number_of_seasons %}
                                <span class="meta-item seasons">
                                    <i class="bi bi-collection-play"></i>
                                    {{ results.number_of_seasons }} Season{{ 's' if results.number_of_seasons > 1 else '' }}
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if results.genres %}
                            <div class="title-genres">
                                {% for genre in results.genres %}
                                <span class="genre-tag">{{ genre.get("name") if genre.get("name") else "Unknown" }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if results.overview %}
                            <div class="title-overview">
                                <h3>Overview</h3>
                                <p>{{ results.overview }}</p>
                            </div>
                        {% endif %}
                        
                        <!-- User Actions -->
                        <div class="user-actions">
                            <!-- Watched Toggle Button -->
                            {% if results.media_type == "tv" and results.seasons %}
                                <!-- TV Series: Link to seasons section -->
                                <a href="#seasons-section" class="title-btn {{ 'filled active' if results.seen else 'outlined' }} toggle-watched-link" 
                                   data-id="{{ results.id }}" 
                                   data-is-watched="{{ 'true' if results.seen else 'false' }}">
                                    <i class="bi bi-{{ 'check-circle-fill' if results.seen else 'check-circle' }}"></i>
                                    <span>{{ 'Watched' if results.seen else 'Add to Watched' }}</span>
                                </a>
                            {% else %}
                                <!-- Movies: Toggle button -->
                                <button class="title-btn {{ 'filled active' if results.seen else 'outlined' }} toggle-watched" 
                                        data-id="{{ results.id }}" 
                                        data-is-watched="{{ 'true' if results.seen else 'false' }}">
                                    <i class="bi bi-{{ 'check-circle-fill' if results.seen else 'check-circle' }}"></i>
                                    <span>{{ 'Watched' if results.seen else 'Add to Watched' }}</span>
                                </button>
                            {% endif %}
                            
                            <!-- Watchlist Toggle Button (hidden when watched) -->
                            <button class="title-btn {{ 'filled active' if results.watchlist else 'outlined' }} toggle-watchlist {{ 'hidden' if results.seen else '' }}" 
                                    data-id="{{ results.id }}" 
                                    data-in-watchlist="{{ 'true' if results.watchlist else 'false' }}">
                                <i class="bi bi-{{ 'bookmark-fill' if results.watchlist else 'bookmark-plus' }}"></i>
                                <span>{{ 'In Watchlist' if results.watchlist else 'Add to Watchlist' }}</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Seasons Section (TV Shows Only) -->
                {% if results.media_type == "tv" and results.seasons %}
                <div class="seasons-section" id="seasons-section">
                    <div class="seasons-header" id="seasons-header">
                        <h3>
                            <i class="bi bi-collection-play"></i>
                            Seasons
                            <span class="seasons-count">({{ results.number_of_seasons }})</span>
                        </h3>
                        <i class="bi bi-chevron-down seasons-toggle-icon"></i>
                    </div>
                    <div class="seasons-dropdown" id="seasons-dropdown">
                        <div class="seasons-list">
                            {% for season in results.seasons %}
                            <div class="season-item" data-season="{{ season.season_number }}">
                                <div class="season-info">
                                    <span class="season-number">Season {{ season.season_number }}</span>
                                    {% if season.name and season.name != ("Season " ~ season.season_number) %}
                                    <span class="season-name">{{ season.name }}</span>
                                    {% endif %}
                                    {% if season.episode_count %}
                                    <span class="season-episodes">{{ season.episode_count }} episodes</span>
                                    {% endif %}
                                </div>
                                <button class="season-select-btn" data-season="{{ season.season_number }}" data-series-id="{{ results.id }}">
                                    <i class="bi bi-check-circle"></i>
                                    Select as Last Seen
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="seasons-actions">
                            <p class="seasons-help-text">
                                <i class="bi bi-info-circle"></i>
                                Select the last season you've watched to track your progress
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="title-not-found">
                <i class="bi bi-film"></i>
                <h2>Title Not Found</h2>
                <p>Oops! The title you're looking for doesn't exist.</p>
                <a href="{{url_for('main.home')}}" class="btn-home">
                    <i class="bi bi-house"></i> Back to Home
                </a>
            </div>
        {% endif %}
    </div>
{% endblock %}

<!-- Scripts -->
{% block js %}
    <script src="{{url_for('static', filename='js/title.js')}}"></script>
{% endblock %}